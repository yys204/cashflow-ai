version: "3.9"

services:
  # 1. æ•°æ®åº“æœåŠ¡
  db:
    container_name: cashflow-db
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: mysecretpassword
      POSTGRES_DB: cashflow
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # ğŸŒŸ å¥åº·æ£€æŸ¥ï¼šç¡®ä¿æ•°æ®åº“çœŸçš„å¯åŠ¨äº†ï¼Œæ‰è®©åˆ«äººè¿
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # 2. ä¸“é—¨è´Ÿè´£å»ºè¡¨çš„"å·¥ç¨‹è½¦"
  migrate:
    container_name: cashflow-migrate
    build:
      context: .
      # ğŸš¨ æ ¸å¿ƒä¿®æ”¹ï¼šæŒ‡å®šä½¿ç”¨ 'builder' é˜¶æ®µï¼
      # builder é˜¶æ®µæœ‰å®Œæ•´çš„ node_modules å’Œ pnpmï¼Œç»å¯¹ä¸ä¼šæŠ¥ command not found
      target: builder
    # è¦†ç›–é»˜è®¤å¯åŠ¨å‘½ä»¤ï¼Œåªåšè¿ç§»è¿™ä¸€ä»¶äº‹
    command: npx prisma migrate deploy
    environment:
      # å¿…é¡»ç»™å®ƒæ•°æ®åº“åœ°å€
      DATABASE_URL: "postgresql://postgres:mysecretpassword@db:5432/cashflow?schema=public"
    depends_on:
      db:
        condition: service_healthy # ç­‰æ•°æ®åº“å¥åº·äº†å†è·‘
    restart: "no" # è·‘å®Œå°±è‡ªæ€é€€å‡ºï¼Œä¸å ç”¨èµ„æº

  # 3. Next.js åº”ç”¨
  app:
    container_name: cashflow-app
    build: .
    restart: always
    ports:
      - "3000:3000"
    environment:
      DATABASE_URL: "postgresql://postgres:mysecretpassword@db:5432/cashflow?schema=public"
      DEEPSEEK_API_KEY: "sk-876e7de89b754894a559ad7087652efd"
      DEEPSEEK_BASE_URL: "https://api.deepseek.com/v1"
    depends_on:
      # ğŸŒŸ å…³é”®ä¾èµ–ï¼šç­‰ migrate è·‘å®Œäº†ï¼ŒApp å†å¯åŠ¨
      migrate:
        condition: service_completed_successfully

volumes:
  postgres_data: